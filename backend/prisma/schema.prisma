// URL de conexão limpa
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --- ENUMS ---

enum EventStatus {
  pending
  approved
  rejected
  finished
  cancelled
}

enum TicketStatus {
  active
  sold_out
  paused
  hidden
  expired
}

enum OrderStatus {
  pending
  processing
  paid
  cancelled
  refunded
  failed
}

enum DiscountType {
  PERCENTAGE      // Ex: 10% OFF no valor total
  FIXED           // Ex: R$ 20,00 OFF no valor total
  PERCENTAGE_FEE  // Ex: 5% OFF na taxa de serviço (Split com parceiro)
}

// --- MODELS ---

model SystemConfig {
  id            String   @id @default(uuid())
  platformFee   Float    @default(0.08) // 8% padrão
  minFee        Float    @default(2.00) // Taxa mínima em R$
  premiumPrice  Float    @default(100.00)
  standardPrice Float    @default(50.00)
  updatedAt     DateTime @updatedAt

  @@map("system_config")
}

model User {
  id        String  @id @default(uuid())
  name      String
  email     String  @unique
  password  String?
  isAdmin   Boolean @default(false)

  // Stripe Data
  stripeAccountId          String?
  stripeOnboardingComplete Boolean @default(false)

  // Profile
  profilePicture String?
  coverPicture   String?
  bio            String?

  // Reset de Senha
  resetPasswordToken   String?
  resetPasswordExpires DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  eventsOrganized Event[]  @relation("EventOrganizer")
  favoritedEvents Event[]  @relation("UserFavorites")
  orders          Order[]
  tickets         Ticket[]

  @@map("users")
}

model Partner {
  id          String  @id @default(uuid())
  name        String
  description String?
  instagram   String?

  // Relations
  coupons Coupon[] // Cupons gerados por este parceiro
  events  Event[] // Eventos associados a este parceiro

  createdAt DateTime @default(now())

  @@map("partners")
}

model Event {
  id          String      @id @default(uuid())
  title       String
  description String
  imageUrl    String
  city        String
  location    String
  category    String
  ageRating   String? // Ex: "Livre", "18+"
  status      EventStatus @default(pending)

  // Link externo (para eventos informativos)
  externalUrl String? 
   
  // Flag Informativo
  isInformational Boolean @default(false)

  // Configurações Financeiras e Destaque
  priceFrom            Float?   // Pode ser nulo se for informativo
  refundPolicy         String
  termsAndConditions   String?
  isFeatured           Boolean @default(false)
  isFeaturedRequested  Boolean @default(false)
  highlightStatus      String  @default("none")
  highlightFee         Float   @default(0)

  // Datas
  eventDate DateTime
  sessions  Json? // Para eventos com múltiplas datas/sessões

  // Formulário Personalizado (FASE 2)
  formSchema Json? // Estrutura das perguntas

  // Relations
  organizerInfo Json? // Dados extras do organizador
  organizerId   String
  organizer     User    @relation("EventOrganizer", fields: [organizerId], references: [id])

  favoritedBy User[] @relation("UserFavorites")

  partnerId String?
  partner   Partner? @relation(fields: [partnerId], references: [id])

  ticketTypes TicketType[]
  coupons     Coupon[] // Cupons exclusivos deste evento
  orders      Order[]
  tickets     Ticket[] // Ingressos gerados

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("events")
}

model TicketType {
  id      String @id @default(uuid())
  eventId String
  event   Event  @relation(fields: [eventId], references: [id])

  name        String  @default("Ingresso")
  description String?
  price       Float // Se 0.00, é Cortesia/Gratuito

  // Controle de Lote e Estoque
  quantity Int // Quantidade total disponibilizada
  sold     Int @default(0) // Quantidade vendida

  // Lógica de Lotes (Batch)
  batchName  String? // Ex: "1º Lote"
  salesStart DateTime?
  salesEnd   DateTime?

  // --- NOVOS CAMPOS PARA HORÁRIO ---
  activityDate DateTime?
  startTime    String?
  endTime      String?
  // ---------------------------------

  isHalfPrice Boolean @default(false) // Meia-entrada
  category    String? // Agrupamento

  maxPerUser Int @default(4)
  minPerUser Int @default(1)

  status TicketStatus @default(active)

  // Relations
  tickets    Ticket[]
  orderItems OrderItem[]

  @@map("ticket_types")
}

model Coupon {
  id          String  @id @default(uuid())
  code        String  @unique
  description String?

  // Configuração do Desconto
  discountType  String // PERCENTAGE, FIXED ou PERCENTAGE_FEE (salvo como string para flexibilidade)
  discountValue Float  // Valor do desconto (ex: 5 para 5%)

  // Dados do Parceiro (Obrigatório para split)
  partner       String // Nome do parceiro (ex: "Gustavo")
  
  // Regras de Uso
  maxUses           Int?      // Null = ilimitado
  usedCount         Int       @default(0)
  usageLimitPerUser Int       @default(1)
  minPurchaseAmount Float?

  validFrom  DateTime?
  validUntil DateTime?
  isActive   Boolean   @default(true)
  expiresAt  DateTime? // Data de expiração simples

  // Vínculos Opcionais (se for cupom específico de evento/parceiro do banco)
  eventId String?
  event   Event?  @relation(fields: [eventId], references: [id])

  partnerId String?
  partnerRef Partner? @relation(fields: [partnerId], references: [id]) // Relação com tabela Partner se existir

  orders Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("coupons")
}

model Order {
  id      String @id @default(uuid())
  userId  String
  user    User   @relation(fields: [userId], references: [id])

  eventId String
  event   Event  @relation(fields: [eventId], references: [id])

  // Cupom aplicado
  couponId String?
  coupon   Coupon? @relation(fields: [couponId], references: [id])

  items OrderItem[]
   
  // Um pedido gera vários ingressos
  tickets Ticket[] 

  // Valores Financeiros
  subtotal       Float
  discountAmount Float       @default(0)
  platformFee    Float
  totalAmount    Float

  // Status e Pagamento
  status          OrderStatus @default(pending)
  paymentIntentId String? // ID do pagamento no Stripe (ou "free_xyz" se grátis)
  paymentMethod   String? // Ex: "credit_card", "pix"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("orders")
}

model OrderItem {
  id      String @id @default(uuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  ticketTypeId String
  ticketType   TicketType @relation(fields: [ticketTypeId], references: [id])

  quantity  Int
  unitPrice Float

  @@map("order_items")
}

model Ticket {
  id String @id @default(uuid())

  ticketTypeId String
  ticketType   TicketType @relation(fields: [ticketTypeId], references: [id])

  eventId String
  event   Event  @relation(fields: [eventId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  // O ingresso pertence a um pedido
  orderId String
  order   Order @relation(fields: [orderId], references: [id])

  qrCodeData String @unique

  price  Float // Preço pago (pode ser 0)
  status String @default("valid") // valid, used, cancelled

  // Dados do Participante (FASE 2)
  participantData Json? // Ex: { matricula: "123" }

  usedAt    DateTime? // Data do Check-in
  createdAt DateTime  @default(now())

  @@map("tickets")
}